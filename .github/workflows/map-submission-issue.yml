name: Map Submission Issue Handler

on:
  issues:
    types: [labeled]

jobs:
  create-mr-from-issue:
    if: github.event.label.name == 'map-upload'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: write

    steps:
      - name: Create labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = [
              {
                name: "map-upload",
                color: "FBCA04",
                description: "Indicates a map submission that is pending review and merging.",
              },
              {
                name: "review",
                color: "0E8A16",
                description: "Indicates that a pull request or issue is ready for review.",
              },
            ];

            for (const label of labels) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name,
                });
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label.name,
                    color: label.color,
                    description: label.description,
                  });
                } else {
                  throw error;
                }
              }
            }
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract and validate map information
        id: extract-info
        run: |
          # Extract map name and author from issue body
          issue_body="${{ github.event.issue.body }}"

          # Parse the issue body to extract map name
          map_name=$(echo "$issue_body" | grep -A1 "Map Name" | tail -1 | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')

          # Parse the issue body to extract map author
          map_author=$(echo "$issue_body" | grep -A1 "Map Author" | tail -1 | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')

          # Parse collaborators (optional field)
          collaborators=$(echo "$issue_body" | grep -A1 "Collaborators" | tail -1 | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')

          # Parse map URL (optional field)
          map_url=$(echo "$issue_body" | grep -A1 "Map File URL" | tail -1 | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')

          # Validation
          validation_errors=""

          # Validate map name
          if [ -z "$map_name" ] || [ "$map_name" = "_No response_" ]; then
            validation_errors="${validation_errors}- Map name is required and cannot be empty\n"
          elif [ ${#map_name} -lt 3 ]; then
            validation_errors="${validation_errors}- Map name must be at least 3 characters long\n"
          elif [ ${#map_name} -gt 100 ]; then
            validation_errors="${validation_errors}- Map name must be less than 100 characters\n"
          fi

          # Validate map author
          if [ -z "$map_author" ] || [ "$map_author" = "_No response_" ]; then
            validation_errors="${validation_errors}- Map author is required and cannot be empty\n"
          elif [ ${#map_author} -lt 2 ]; then
            validation_errors="${validation_errors}- Map author must be at least 2 characters long\n"
          elif [ ${#map_author} -gt 50 ]; then
            validation_errors="${validation_errors}- Map author must be less than 50 characters\n"
          fi

          # If there are validation errors, report them and exit
          if [ -n "$validation_errors" ]; then
            echo "validation_failed=true" >> $GITHUB_OUTPUT
            echo "validation_errors<<EOF" >> $GITHUB_OUTPUT
            echo -e "$validation_errors" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "validation_failed=false" >> $GITHUB_OUTPUT

          # Clean up the map name for branch naming (remove special chars)
          branch_name=$(echo "$map_name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//')

          echo "map_name=$map_name" >> $GITHUB_OUTPUT
          echo "map_author=$map_author" >> $GITHUB_OUTPUT
          echo "collaborators=$collaborators" >> $GITHUB_OUTPUT
          echo "map_url=$map_url" >> $GITHUB_OUTPUT
          echo "branch_name=map-submission-$branch_name-issue-${{ github.event.issue.number }}" >> $GITHUB_OUTPUT

      - name: Create branch for map submission
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "${{ steps.extract-info.outputs.branch_name }}"

          # Create a placeholder file to commit (will be replaced by actual map)
          mkdir -p maps/pending-upload
          cat > maps/pending-upload/README-issue-${{ github.event.issue.number }}.md << 'EOF'
          # Map Upload Pending

          **Map Name:** ${{ steps.extract-info.outputs.map_name }}
          **Author:** ${{ steps.extract-info.outputs.map_author }}
          **Issue:** #${{ github.event.issue.number }}

          This is a placeholder. Please upload your map file to this pull request.
          EOF

          git add .
          git commit -m "chore: create map submission for ${{ steps.extract-info.outputs.map_name }} (issue #${{ github.event.issue.number }})"
          git push origin "${{ steps.extract-info.outputs.branch_name }}"

      - name: Create Pull Request
        id: create-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const collaborators = '${{ steps.extract-info.outputs.collaborators }}';
            const collaboratorsList = collaborators
              .split(',')
              .map(c => c.trim().replace('@', ''))
              .filter(c => c.length > 0);

            let collaboratorsText = '';
            if (collaboratorsList.length > 0) {
              collaboratorsText = '\n**Collaborators:** ' + collaboratorsList.map(c => '@' + c).join(', ');
            }

            const mapUrl = '${{ steps.extract-info.outputs.map_url }}';
            let mapUrlText = '';
            if (mapUrl && mapUrl.trim().length > 0 && mapUrl.startsWith('http')) {
              mapUrlText = '\n**Map File URL:** ' + mapUrl + '\n\n> üí° You can download the map from the URL above, or the submitter can upload it directly to this PR.';
            }

            const allowedUsers = ['@${{ github.event.issue.user.login }}'];
            if (collaboratorsList.length > 0) {
              allowedUsers.push(...collaboratorsList.map(c => '@' + c));
            }

            const mapName = '${{ steps.extract-info.outputs.map_name }}';
            const mapAuthor = '${{ steps.extract-info.outputs.map_author }}';
            const branchName = '${{ steps.extract-info.outputs.branch_name }}';
            const issueNumber = ${{ github.event.issue.number }};
            const issueAuthor = '${{ github.event.issue.user.login }}';

            const prTitle = '[Map Upload] ' + mapName;
            const collaboratorSuffix = collaboratorsList.length > 0 ? ' and collaborators' : '';
            const prBody = '## Map Submission from Issue #' + issueNumber + '\n\n' +
              '**Map Name:** ' + mapName + '\n' +
              '**Author:** ' + mapAuthor + collaboratorsText + mapUrlText + '\n\n' +
              '---\n\n' +
              '### üì§ Next Steps\n\n' +
              '**@' + issueAuthor + '**' + collaboratorSuffix + ', please upload your map file to this pull request:\n\n' +
              '1. Click on "Files changed" tab above\n' +
              '2. Click "Add file" ‚Üí "Upload files"\n' +
              '3. Drag and drop your map file (`.map` file)\n' +
              '4. Make sure to place it in the correct directory (e.g., `maps/`)\n' +
              '5. Commit your changes\n\n' +
              '### ‚ö†Ô∏è Important Notes\n\n' +
              '- **Allowed contributors:** ' + allowedUsers.join(', ') + '\n' +
              '- Collaborators need to fork the repo and push to the branch `' + branchName + '`\n' +
              '- Please upload the actual map file and remove the placeholder README\n' +
              '- Your map will be automatically validated once uploaded\n\n' +
              '---\n\n' +
              'Closes #' + issueNumber;

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: prTitle,
              head: branchName,
              base: 'main',
              body: prBody
            });

            // Store collaborators for next step
            core.setOutput('collaborators_list', collaboratorsList.join(','));

            return pr.number;

      - name: Add collaborators and labels to PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.create-pr.outputs.result }};
            const collaboratorsList = '${{ steps.create-pr.outputs.collaborators_list }}'.split(',').filter(c => c.length > 0);

            // Add the map-upload label to the PR
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['map-upload', 'review']
            });

            // Add issue creator and collaborators as assignees
            const assignees = ['${{ github.event.issue.user.login }}', ...collaboratorsList];
            if (assignees.length > 0) {
              try {
                await github.rest.issues.addAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  assignees: assignees
                });
              } catch (error) {
                console.log('Note: Some users might not have permission to be assigned:', error.message);
              }
            }

            // Comment on PR to notify collaborators
            if (collaboratorsList.length > 0) {
              const collaboratorMentions = collaboratorsList.map(c => '@' + c).join(' ');
              const branchName = '${{ steps.extract-info.outputs.branch_name }}';
              const issueAuthor = '${{ github.event.issue.user.login }}';
              const commentBody = 'üëã ' + collaboratorMentions + ' - You\'ve been added as a collaborator on this map submission!\n\n' +
                'You can contribute to this PR by:\n' +
                '1. Forking this repository (if you haven\'t already)\n' +
                '2. Adding this repository as a remote\n' +
                '3. Fetching and checking out the branch: `' + branchName + '`\n' +
                '4. Making your changes and pushing to this branch\n' +
                '5. Or using the GitHub UI to upload files directly to this PR\n\n' +
                'Let @' + issueAuthor + ' know if you need any help! üöÄ';

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            }

      - name: Close issue with instructions
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.create-pr.outputs.result }};
            const collaboratorsList = '${{ steps.create-pr.outputs.collaborators_list }}'.split(',').filter(c => c.length > 0);
            const issueNumber = ${{ github.event.issue.number }};
            const issueAuthor = '${{ github.event.issue.user.login }}';

            let collaboratorText = '';
            if (collaboratorsList.length > 0) {
              const collaboratorMentions = collaboratorsList.map(c => '@' + c).join(', ');
              collaboratorText = '\n- Your collaborators (' + collaboratorMentions + ') have been notified and can also contribute';
            }

            const issueCommentBody = 'Thank you for your map submission! üéÆ\n\n' +
              'A pull request has been automatically created for your map: #' + prNumber + '\n\n' +
              '## üì§ Please upload your map file to the pull request\n\n' +
              '**Important:** Instead of uploading here in this issue, please go to the pull request and upload your map file there.\n\n' +
              '### How to upload:\n\n' +
              '1. Go to pull request #' + prNumber + '\n' +
              '2. Click on the "Files changed" tab\n' +
              '3. Click "Add file" ‚Üí "Upload files" (or use the GitHub UI)\n' +
              '4. Upload your `.map` file to the appropriate directory\n' +
              '5. Commit the changes\n\n' +
              '### ‚ö†Ô∏è Upload Permissions\n\n' +
              '- You (@' + issueAuthor + ') and any collaborators can push changes to this pull request' + collaboratorText + '\n' +
              '- Code owners will review your submission once the map file is uploaded\n\n' +
              'This issue will now be closed. All further discussion should happen in the pull request.\n\n' +
              'See you in PR #' + prNumber + '! üöÄ';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: issueCommentBody
            });

            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              state_reason: 'completed'
            });
